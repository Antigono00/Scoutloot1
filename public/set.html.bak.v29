<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Primary SEO - Will be replaced server-side -->
  <title>LEGO Set Details | ScoutLoot</title>
  <meta name="description" content="View current LEGO deals and price history. Track this set and get instant alerts when prices drop.">
  <meta name="keywords" content="LEGO deals, LEGO price tracker, LEGO price history, eBay LEGO">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://scoutloot.com/set/">
  
  <!-- Open Graph -->
  <meta property="og:type" content="product">
  <meta property="og:url" content="https://scoutloot.com/set/">
  <meta property="og:title" content="LEGO Set Details | ScoutLoot">
  <meta property="og:description" content="View current LEGO deals and price history.">
  <meta property="og:image" content="https://scoutloot.com/og-image.png">
  <meta property="og:site_name" content="ScoutLoot">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="LEGO Set Details | ScoutLoot">
  <meta name="twitter:description" content="View current LEGO deals and price history.">
  <meta name="twitter:image" content="https://scoutloot.com/og-image.png">
  
  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0A0A0F">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="/icon-192.png">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <!-- Styles -->
  <link rel="stylesheet" href="/css/styles.css">
  
  <style>
    /* Set Page Specific Styles */
    .set-page {
      padding-top: calc(var(--nav-height) + 40px);
      padding-bottom: 80px;
      min-height: 100vh;
    }
    
    .set-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 40px;
    }
    
    /* Breadcrumb */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 24px;
    }
    
    .breadcrumb a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .breadcrumb a:hover {
      color: var(--accent);
    }
    
    .breadcrumb span {
      color: var(--text-muted);
    }
    
    /* Set Header */
    .set-header {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 40px;
      margin-bottom: 48px;
    }
    
    .set-image-container {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 24px;
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .set-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .set-image-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      color: var(--text-muted);
    }
    
    .set-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .set-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 213, 0, 0.1);
      border: 1px solid rgba(255, 213, 0, 0.3);
      padding: 6px 12px;
      border-radius: 100px;
      font-size: 0.8rem;
      color: var(--accent);
      width: fit-content;
      margin-bottom: 16px;
    }
    
    .set-number {
      font-family: 'Space Mono', monospace;
      font-size: 1rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    
    .set-name {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 16px;
    }
    
    .set-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      margin-bottom: 24px;
    }
    
    .set-meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }
    
    .set-meta-item .icon {
      font-size: 1.1rem;
    }
    
    .set-meta-item .value {
      font-weight: 500;
      color: var(--text-primary);
    }
    
    /* Quick Stats */
    .quick-stats {
      display: flex;
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .quick-stat {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 16px 24px;
    }
    
    .quick-stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    
    .quick-stat-value {
      font-family: 'Space Mono', monospace;
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .quick-stat-value.price {
      color: var(--success);
    }
    
    .quick-stat-value.watchers {
      color: var(--accent);
    }
    
    .quick-stat-trend {
      font-size: 0.85rem;
      margin-top: 4px;
    }
    
    .quick-stat-trend.up {
      color: var(--error);
    }
    
    .quick-stat-trend.down {
      color: var(--success);
    }
    
    /* Track CTA */
    .track-cta {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .track-cta .btn {
      padding: 14px 32px;
    }
    
    .track-cta-note {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    /* Content Grid */
    .set-content {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 32px;
    }
    
    /* Cards */
    .content-card {
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .content-card h2 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .content-card h2 .icon {
      font-size: 1.3rem;
    }
    
    /* Deals Section */
    .deals-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 8px;
      width: fit-content;
    }
    
    .deals-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .deals-tab:hover {
      color: var(--text-primary);
    }
    
    .deals-tab.active {
      background: var(--bg-card);
      color: var(--text-primary);
    }
    
    .deals-tab .count {
      background: rgba(255,255,255,0.1);
      padding: 2px 8px;
      border-radius: 100px;
      font-size: 0.8rem;
      margin-left: 8px;
    }
    
    .deals-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .deal-card {
      background: var(--bg-tertiary);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 16px;
      display: grid;
      grid-template-columns: 80px 1fr auto;
      gap: 16px;
      align-items: center;
      transition: all 0.2s;
    }
    
    .deal-card:hover {
      border-color: rgba(255, 213, 0, 0.3);
    }
    
    .deal-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      background: var(--bg-secondary);
    }
    
    .deal-info {
      min-width: 0;
    }
    
    .deal-title {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .deal-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    
    .deal-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .deal-marketplace {
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .deal-seller-rating {
      color: var(--success);
    }
    
    .deal-pricing {
      text-align: right;
    }
    
    .deal-total {
      font-family: 'Space Mono', monospace;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 4px;
    }
    
    .deal-breakdown {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .deal-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--accent);
      color: var(--bg-primary);
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 8px;
      transition: all 0.2s;
    }
    
    .deal-link:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    
    .no-deals {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    
    .no-deals-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }
    
    /* Chart Section */
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }
    
    .chart-legend {
      display: flex;
      gap: 20px;
      margin-top: 16px;
      justify-content: center;
    }
    
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .chart-legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    
    .chart-legend-color.new-min {
      background: #10B981;
    }
    
    .chart-legend-color.new-avg {
      background: rgba(16, 185, 129, 0.4);
    }
    
    .chart-legend-color.used-min {
      background: #FFD500;
    }
    
    /* Building State */
    .history-building {
      text-align: center;
      padding: 40px 20px;
    }
    
    .history-building-icon {
      font-size: 3rem;
      margin-bottom: 12px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .history-building h3 {
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    
    .history-building p {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    
    .history-building .highlight {
      color: var(--accent);
      font-weight: 500;
    }
    
    /* No Data State */
    .history-empty {
      text-align: center;
      padding: 40px 20px;
    }
    
    .history-empty-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }
    
    .history-empty h3 {
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    
    .history-empty p {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }
    
    /* Sidebar */
    .sidebar {
      position: sticky;
      top: calc(var(--nav-height) + 40px);
    }
    
    .track-card {
      background: linear-gradient(180deg, rgba(255, 213, 0, 0.1) 0%, var(--bg-card) 100%);
      border: 1px solid rgba(255, 213, 0, 0.3);
    }
    
    .track-card h2 {
      color: var(--accent);
    }
    
    .track-card p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    
    .track-card .btn {
      width: 100%;
      padding: 14px 24px;
      font-size: 1rem;
    }
    
    .track-benefits {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .track-benefit {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    
    .track-benefit .icon {
      color: var(--success);
      flex-shrink: 0;
    }
    
    /* Stats Card */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .stat-item {
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 16px;
    }
    
    .stat-item-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    
    .stat-item-value {
      font-family: 'Space Mono', monospace;
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .stat-item-value.positive {
      color: var(--success);
    }
    
    .stat-item-value.negative {
      color: var(--error);
    }
    
    /* Loading State */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      gap: 16px;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--bg-tertiary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: var(--text-muted);
    }
    
    /* Error State */
    .error-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      gap: 16px;
      text-align: center;
    }
    
    .error-icon {
      font-size: 4rem;
    }
    
    .error-container h2 {
      font-size: 1.5rem;
    }
    
    .error-container p {
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .set-content {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        position: static;
      }
    }
    
    @media (max-width: 768px) {
      .set-container {
        padding: 0 20px;
      }
      
      .set-header {
        grid-template-columns: 1fr;
        gap: 24px;
      }
      
      .set-image-container {
        max-width: 300px;
        margin: 0 auto;
      }
      
      .set-name {
        font-size: 1.75rem;
      }
      
      .quick-stats {
        flex-wrap: wrap;
      }
      
      .quick-stat {
        flex: 1;
        min-width: 140px;
      }
      
      .deal-card {
        grid-template-columns: 60px 1fr;
      }
      
      .deal-pricing {
        grid-column: 1 / -1;
        text-align: left;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 8px;
      }
    }
  </style>
  
  <!-- JSON-LD will be injected server-side -->
  <script id="json-ld" type="application/ld+json"></script>
</head>
<body>
  <div class="bg-pattern"></div>
  
  <!-- Navigation -->
  <nav>
    <a href="/" class="logo">
      <img src="/logo-icon.png" alt="ScoutLoot" class="logo-icon">
      <span>ScoutLoot</span>
    </a>
    
    <div class="nav-links">
      <a href="/#how-it-works">How It Works</a>
      <a href="/#features">Features</a>
      <a href="/#pricing">Pricing</a>
    </div>
    
    <div class="nav-auth" id="nav-auth">
      <button class="btn btn-ghost" onclick="openLoginModal()">Log In</button>
      <button class="btn btn-primary" onclick="openSignupModal()">Get Started</button>
    </div>
    
    <div class="user-menu" id="user-menu" style="display: none;">
      <button class="user-btn">
        <div class="user-avatar" id="user-avatar">J</div>
        <span id="user-email">user@example.com</span>
        <span>‚ñº</span>
      </button>
      <div class="user-dropdown">
        <a href="/">
          <span>üìä</span> Dashboard
        </a>
        <button class="logout-btn" onclick="logout()">
          <span>üö™</span> Log Out
        </button>
      </div>
    </div>
  </nav>
  
  <!-- Main Content -->
  <main class="set-page">
    <div class="set-container">
      <!-- Loading State -->
      <div id="loading-state" class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading set details...</div>
      </div>
      
      <!-- Error State -->
      <div id="error-state" class="error-container" style="display: none;">
        <div class="error-icon">üòï</div>
        <h2>Set Not Found</h2>
        <p id="error-message">We couldn't find this LEGO set. Please check the set number and try again.</p>
        <a href="/" class="btn btn-primary">Go to Homepage</a>
      </div>
      
      <!-- Content (Hidden until loaded) -->
      <div id="set-content" style="display: none;">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
          <a href="/">Home</a>
          <span>‚Ä∫</span>
          <span id="breadcrumb-set">Set #75192</span>
        </div>
        
        <!-- Set Header -->
        <div class="set-header">
          <div class="set-image-container">
            <img id="set-image" class="set-image" src="" alt="" style="display: none;">
            <div id="set-image-placeholder" class="set-image-placeholder">üß±</div>
          </div>
          
          <div class="set-info">
            <div class="set-badge" id="set-theme-badge" style="display: none;">
              <span id="set-theme"></span>
            </div>
            <div class="set-number" id="set-number-display">#75192</div>
            <h1 class="set-name" id="set-name">Loading...</h1>
            
            <div class="set-meta">
              <div class="set-meta-item" id="meta-year" style="display: none;">
                <span class="icon">üìÖ</span>
                <span class="value" id="set-year"></span>
              </div>
              <div class="set-meta-item" id="meta-pieces" style="display: none;">
                <span class="icon">üß±</span>
                <span class="value" id="set-pieces"></span> pieces
              </div>
            </div>
            
            <div class="quick-stats">
              <div class="quick-stat" id="quick-stat-price" style="display: none;">
                <div class="quick-stat-label">Best Price (New)</div>
                <div class="quick-stat-value price" id="best-price">-</div>
                <div class="quick-stat-trend" id="price-trend"></div>
              </div>
              <div class="quick-stat" id="quick-stat-watchers" style="display: none;">
                <div class="quick-stat-label">Collectors Tracking</div>
                <div class="quick-stat-value watchers" id="watchers-count">0</div>
              </div>
            </div>
            
            <div class="track-cta">
              <button class="btn btn-primary" id="track-btn" onclick="trackSet()">
                üîî Track This Set
              </button>
              <span class="track-cta-note">Get alerts when prices drop</span>
            </div>
          </div>
        </div>
        
        <!-- Content Grid -->
        <div class="set-content">
          <!-- Main Content -->
          <div class="main-content">
            <!-- Current Deals -->
            <div class="content-card">
              <h2><span class="icon">üí∞</span> Current Deals</h2>
              
              <div class="deals-tabs">
                <button class="deals-tab active" data-condition="new" onclick="switchDealsTab('new')">
                  New <span class="count" id="new-count">0</span>
                </button>
                <button class="deals-tab" data-condition="used" onclick="switchDealsTab('used')">
                  Used <span class="count" id="used-count">0</span>
                </button>
              </div>
              
              <div class="deals-list" id="deals-list">
                <div class="no-deals">
                  <div class="no-deals-icon">üîç</div>
                  <p>No deals found yet. Check back soon!</p>
                </div>
              </div>
            </div>
            
            <!-- Price History -->
            <div class="content-card">
              <h2><span class="icon">üìà</span> Price History</h2>
              
              <!-- State A: Good data (7+ days) -->
              <div id="history-chart-container" style="display: none;">
                <div class="chart-container">
                  <canvas id="price-chart"></canvas>
                </div>
                <div class="chart-legend">
                  <div class="chart-legend-item">
                    <div class="chart-legend-color new-min"></div>
                    <span>New (Best Price)</span>
                  </div>
                  <div class="chart-legend-item">
                    <div class="chart-legend-color new-avg"></div>
                    <span>New (Average)</span>
                  </div>
                  <div class="chart-legend-item">
                    <div class="chart-legend-color used-min"></div>
                    <span>Used (Best Price)</span>
                  </div>
                </div>
              </div>
              
              <!-- State B: Limited data (1-6 days) -->
              <div id="history-building" class="history-building" style="display: none;">
                <div class="history-building-icon">‚è≥</div>
                <h3>Building price history...</h3>
                <p>Tracking since: <span class="highlight" id="tracking-since">-</span></p>
                <p>Data points: <span class="highlight" id="data-points">0</span> days</p>
                <p style="margin-top: 16px;">üí° Check back in a few days for trend data!</p>
              </div>
              
              <!-- State C: No data -->
              <div id="history-empty" class="history-empty" style="display: none;">
                <div class="history-empty-icon">üÜï</div>
                <h3>No price data yet</h3>
                <p>We're not tracking this set yet. Be the first to add it to your watchlist!</p>
                <button class="btn btn-primary" onclick="trackSet()">üîî Track This Set</button>
                <p style="margin-top: 12px; font-size: 0.8rem;">Once tracked, we'll start collecting price data and alert you to deals.</p>
              </div>
            </div>
          </div>
          
          <!-- Sidebar -->
          <div class="sidebar">
            <!-- Track Card -->
            <div class="content-card track-card">
              <h2><span class="icon">üîî</span> Track This Set</h2>
              <p>Get instant alerts when this set hits your target price on eBay across USA, Canada, UK & Europe.</p>
              <button class="btn btn-primary" onclick="trackSet()">Start Tracking</button>
              <div class="track-benefits">
                <div class="track-benefit">
                  <span class="icon">‚úî</span>
                  <span>Instant Telegram & push notifications</span>
                </div>
                <div class="track-benefit">
                  <span class="icon">‚úî</span>
                  <span>Scans eBay every 30 minutes</span>
                </div>
                <div class="track-benefit">
                  <span class="icon">‚úî</span>
                  <span>Set your own target price</span>
                </div>
                <div class="track-benefit">
                  <span class="icon">‚úî</span>
                  <span>Free for up to 3 sets</span>
                </div>
              </div>
            </div>
            
            <!-- Stats Card -->
            <div class="content-card" id="stats-card" style="display: none;">
              <h2><span class="icon">üìä</span> Statistics</h2>
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-item-label">7-Day Trend</div>
                  <div class="stat-item-value" id="trend-7d">-</div>
                </div>
                <div class="stat-item">
                  <div class="stat-item-label">30-Day Trend</div>
                  <div class="stat-item-value" id="trend-30d">-</div>
                </div>
                <div class="stat-item">
                  <div class="stat-item-label">Lowest Seen</div>
                  <div class="stat-item-value positive" id="lowest-seen">-</div>
                </div>
                <div class="stat-item">
                  <div class="stat-item-label">Days Tracked</div>
                  <div class="stat-item-value" id="days-tracked">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <div class="footer-brand">
        <a href="/" class="logo">
          <img src="/logo-icon.png" alt="ScoutLoot" class="logo-icon">
          <span>ScoutLoot</span>
        </a>
        <p>Find the best LEGO deals.<br>Never overpay again.</p>
      </div>
      
      <div class="footer-column">
        <h4>Product</h4>
        <ul>
          <li><a href="/#how-it-works">How It Works</a></li>
          <li><a href="/#features">Features</a></li>
          <li><a href="/#pricing">Pricing</a></li>
        </ul>
      </div>
      
      <div class="footer-column">
        <h4>Legal</h4>
        <ul>
          <li><a href="/privacy">Privacy Policy</a></li>
          <li><a href="/terms">Terms of Service</a></li>
          <li><a href="/cookies">Cookie Policy</a></li>
        </ul>
      </div>
      
      <div class="footer-column">
        <h4>Support</h4>
        <ul>
          <li><a href="/faq">FAQ</a></li>
          <li><a href="mailto:hello@scoutloot.com">Contact</a></li>
        </ul>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>¬© 2026 ScoutLoot. Not affiliated with the LEGO Group.</p>
    </div>
  </footer>

  <script>
    // ============================================
    // STATE
    // ============================================
    let currentSetData = null;
    let currentCondition = 'new';
    let priceChart = null;
    
    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Extract set number from URL
      const pathParts = window.location.pathname.split('/');
      const setNumber = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];
      
      if (!setNumber) {
        showError('No set number provided');
        return;
      }
      
      // Normalize set number (remove -1 suffix if present)
      const normalizedSetNumber = setNumber.replace(/-\d+$/, '');
      
      // Redirect if URL has suffix
      if (setNumber !== normalizedSetNumber) {
        window.location.replace(`/set/${normalizedSetNumber}`);
        return;
      }
      
      // Check auth state
      checkAuth();
      
      // Load set data
      await loadSetData(normalizedSetNumber);
      
      // Track page view
      trackPageView(normalizedSetNumber);
    });
    
    // ============================================
    // AUTH
    // ============================================
    function checkAuth() {
      const token = localStorage.getItem('scoutloot_user');
      const user = JSON.parse(localStorage.getItem('scoutloot_user') || 'null');
      
      if (token && user) {
        document.getElementById('nav-auth').style.display = 'none';
        document.getElementById('user-menu').style.display = 'flex';
        document.getElementById('user-email').textContent = user.email;
        document.getElementById('user-avatar').textContent = user.email[0].toUpperCase();
      }
    }
    
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/';
    }
    
    function openLoginModal() {
      // Redirect to homepage and trigger login modal
      window.location.href = '/?action=login';
    }
    
    function openSignupModal() {
      // Redirect to homepage and trigger signup modal
      window.location.href = '/?action=signup';
    }
    
    // ============================================
    // DATA LOADING
    // ============================================
    async function loadSetData(setNumber) {
      try {
        const response = await fetch(`/api/sets/${setNumber}/detail`);
        
        if (!response.ok) {
          if (response.status === 404) {
            showError(`Set #${setNumber} was not found in our database.`);
          } else {
            showError('Failed to load set data. Please try again.');
          }
          return;
        }
        
        const data = await response.json();
        currentSetData = data;
        
        renderSetPage(data);
        
      } catch (error) {
        console.error('Error loading set:', error);
        showError('Failed to load set data. Please check your connection and try again.');
      }
    }
    
    function trackPageView(setNumber) {
      fetch(`/api/sets/${setNumber}/view`, { method: 'POST' }).catch(() => {});
    }
    
    // ============================================
    // RENDERING
    // ============================================
    function renderSetPage(data) {
      const { set, deals, history, stats } = data;
      
      // Update document title
      document.title = `LEGO ${set.set_number} ${set.name} - Price Tracker | ScoutLoot`;
      
      // Update meta description
      const metaDesc = document.querySelector('meta[name="description"]');
      if (metaDesc) {
        metaDesc.content = `Track prices for LEGO ${set.set_number} ${set.name}. Current best price, price history, and instant deal alerts.`;
      }
      
      // Update canonical URL
      const canonical = document.querySelector('link[rel="canonical"]');
      if (canonical) {
        canonical.href = `https://scoutloot.com/set/${set.set_number}`;
      }
      
      // Update JSON-LD
      updateJsonLd(data);
      
      // Breadcrumb
      document.getElementById('breadcrumb-set').textContent = `${set.name} #${set.set_number}`;
      
      // Set image
      if (set.image_url) {
        const img = document.getElementById('set-image');
        img.src = set.image_url;
        img.alt = `LEGO ${set.set_number} ${set.name}`;
        img.style.display = 'block';
        img.onerror = () => {
          img.style.display = 'none';
          document.getElementById('set-image-placeholder').style.display = 'flex';
        };
        document.getElementById('set-image-placeholder').style.display = 'none';
      }
      
      // Set info
      document.getElementById('set-number-display').textContent = `#${set.set_number}`;
      document.getElementById('set-name').textContent = set.name || 'Unknown Set';
      
      // Theme badge
      if (set.theme) {
        document.getElementById('set-theme').textContent = set.theme;
        document.getElementById('set-theme-badge').style.display = 'flex';
      }
      
      // Meta info
      if (set.year) {
        document.getElementById('set-year').textContent = set.year;
        document.getElementById('meta-year').style.display = 'flex';
      }
      
      if (set.pieces) {
        document.getElementById('set-pieces').textContent = set.pieces.toLocaleString();
        document.getElementById('meta-pieces').style.display = 'flex';
      }
      
      // Quick stats
      const newDeals = deals.new || [];
      if (newDeals.length > 0) {
        const bestPrice = newDeals[0].total_eur;
        document.getElementById('best-price').textContent = `‚Ç¨${bestPrice.toFixed(2)}`;
        document.getElementById('quick-stat-price').style.display = 'block';
        
        // Show trend if available
        if (stats.trend_7d !== null) {
          const trendEl = document.getElementById('price-trend');
          const trendVal = stats.trend_7d;
          trendEl.textContent = `${trendVal > 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(trendVal).toFixed(1)}% (7d)`;
          trendEl.className = 'quick-stat-trend ' + (trendVal > 0 ? 'up' : 'down');
        }
      }
      
      if (stats.watchers > 0) {
        document.getElementById('watchers-count').textContent = stats.watchers;
        document.getElementById('quick-stat-watchers').style.display = 'block';
      }
      
      // Render deals
      renderDeals(deals);
      
      // Render history based on data availability
      renderHistory(history, stats);
      
      // Show content
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('set-content').style.display = 'block';
    }
    
    function updateJsonLd(data) {
      const { set, deals } = data;
      const newDeals = deals.new || [];
      
      const jsonLd = {
        "@context": "https://schema.org",
        "@type": "Product",
        "name": `LEGO ${set.set_number} ${set.name}`,
        "description": `Track prices for LEGO ${set.set_number} ${set.name}. Get alerts when prices drop.`,
        "brand": {
          "@type": "Brand",
          "name": "LEGO"
        },
        "sku": set.set_number,
        "image": set.image_url || "https://scoutloot.com/og-image.png",
        "url": `https://scoutloot.com/set/${set.set_number}`
      };
      
      // Add offer if we have price data
      if (newDeals.length > 0) {
        jsonLd.offers = {
          "@type": "AggregateOffer",
          "priceCurrency": "EUR",
          "lowPrice": newDeals[0].total_eur,
          "offerCount": newDeals.length,
          "availability": "https://schema.org/InStock"
        };
      }
      
      const script = document.getElementById('json-ld');
      script.textContent = JSON.stringify(jsonLd);
    }
    
    function renderDeals(deals) {
      const newDeals = deals.new || [];
      const usedDeals = deals.used || [];
      
      // Update counts
      document.getElementById('new-count').textContent = newDeals.length;
      document.getElementById('used-count').textContent = usedDeals.length;
      
      // Render initial (new) deals
      renderDealsList(newDeals);
    }
    
    function renderDealsList(deals) {
      const container = document.getElementById('deals-list');
      
      if (deals.length === 0) {
        container.innerHTML = `
          <div class="no-deals">
            <div class="no-deals-icon">üîç</div>
            <p>No ${currentCondition} deals found yet. Check back soon!</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = deals.map(deal => `
        <div class="deal-card">
          <img 
            class="deal-image" 
            src="${deal.image_url || '/og-image.png'}" 
            alt="${deal.title}"
            onerror="this.src='/og-image.png'"
            loading="lazy"
          >
          <div class="deal-info">
            <div class="deal-title">${escapeHtml(deal.title)}</div>
            <div class="deal-meta">
              <span class="deal-meta-item deal-marketplace">${formatMarketplace(deal.marketplace)}</span>
              <span class="deal-meta-item">üìç ${deal.seller_country || 'Unknown'}</span>
              ${deal.seller_rating ? `<span class="deal-meta-item deal-seller-rating">‚≠ê ${deal.seller_rating}%</span>` : ''}
            </div>
          </div>
          <div class="deal-pricing">
            <div class="deal-total">‚Ç¨${deal.total_eur.toFixed(2)}</div>
            <div class="deal-breakdown">
              ‚Ç¨${deal.price_eur.toFixed(2)} + ‚Ç¨${deal.shipping_eur.toFixed(2)} shipping
            </div>
            <a href="${deal.url}" target="_blank" rel="noopener" class="deal-link">
              View Deal ‚Üí
            </a>
          </div>
        </div>
      `).join('');
    }
    
    function switchDealsTab(condition) {
      currentCondition = condition;
      
      // Update tabs
      document.querySelectorAll('.deals-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.condition === condition);
      });
      
      // Render deals for selected condition
      const deals = currentCondition === 'new' 
        ? (currentSetData?.deals?.new || [])
        : (currentSetData?.deals?.used || []);
      
      renderDealsList(deals);
    }
    
    function renderHistory(history, stats) {
      const daysTracked = history.days_tracked || 0;
      
      // Hide all states first
      document.getElementById('history-chart-container').style.display = 'none';
      document.getElementById('history-building').style.display = 'none';
      document.getElementById('history-empty').style.display = 'none';
      document.getElementById('stats-card').style.display = 'none';
      
      if (daysTracked >= 7) {
        // State A: Good data - show chart
        renderPriceChart(history.data);
        document.getElementById('history-chart-container').style.display = 'block';
        renderStats(stats, daysTracked);
      } else if (daysTracked >= 1) {
        // State B: Limited data - show building message
        document.getElementById('tracking-since').textContent = formatDate(history.first_tracked);
        document.getElementById('data-points').textContent = daysTracked;
        document.getElementById('history-building').style.display = 'block';
        
        // Still show stats if we have some
        if (stats.lowest_seen) {
          renderStats(stats, daysTracked);
        }
      } else {
        // State C: No data
        document.getElementById('history-empty').style.display = 'block';
      }
    }
    
    function renderPriceChart(historyData) {
      const newData = historyData.new || [];
      const usedData = historyData.used || [];
      
      // Get all unique dates
      const allDates = [...new Set([
        ...newData.map(d => d.date),
        ...usedData.map(d => d.date)
      ])].sort();
      
      // Prepare datasets
      const newMinPrices = allDates.map(date => {
        const point = newData.find(d => d.date === date);
        return point ? point.min : null;
      });
      
      const newAvgPrices = allDates.map(date => {
        const point = newData.find(d => d.date === date);
        return point ? point.avg : null;
      });
      
      const usedMinPrices = allDates.map(date => {
        const point = usedData.find(d => d.date === date);
        return point ? point.min : null;
      });
      
      // Format labels
      const labels = allDates.map(date => {
        const d = new Date(date);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      
      // Create chart
      const ctx = document.getElementById('price-chart').getContext('2d');
      
      if (priceChart) {
        priceChart.destroy();
      }
      
      priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'New (Best)',
              data: newMinPrices,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true,
              pointRadius: 3,
              pointHoverRadius: 6,
            },
            {
              label: 'New (Avg)',
              data: newAvgPrices,
              borderColor: 'rgba(16, 185, 129, 0.4)',
              borderWidth: 1,
              borderDash: [5, 5],
              tension: 0.3,
              fill: false,
              pointRadius: 0,
              pointHoverRadius: 4,
            },
            {
              label: 'Used (Best)',
              data: usedMinPrices,
              borderColor: '#FFD500',
              backgroundColor: 'rgba(255, 213, 0, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true,
              pointRadius: 3,
              pointHoverRadius: 6,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#16161F',
              titleColor: '#FFFFFF',
              bodyColor: '#A0A0B0',
              borderColor: 'rgba(255,255,255,0.1)',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: function(context) {
                  if (context.raw === null) return null;
                  return `${context.dataset.label}: ‚Ç¨${context.raw.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(255,255,255,0.05)'
              },
              ticks: {
                color: '#606070',
                maxRotation: 45
              }
            },
            y: {
              grid: {
                color: 'rgba(255,255,255,0.05)'
              },
              ticks: {
                color: '#606070',
                callback: function(value) {
                  return '‚Ç¨' + value;
                }
              }
            }
          }
        }
      });
    }
    
    function renderStats(stats, daysTracked) {
      document.getElementById('stats-card').style.display = 'block';
      
      // 7-day trend
      const trend7dEl = document.getElementById('trend-7d');
      if (stats.trend_7d !== null) {
        const val = stats.trend_7d;
        trend7dEl.textContent = `${val > 0 ? '+' : ''}${val.toFixed(1)}%`;
        trend7dEl.className = 'stat-item-value ' + (val > 0 ? 'negative' : 'positive');
      } else {
        trend7dEl.textContent = '-';
        trend7dEl.className = 'stat-item-value';
      }
      
      // 30-day trend
      const trend30dEl = document.getElementById('trend-30d');
      if (stats.trend_30d !== null) {
        const val = stats.trend_30d;
        trend30dEl.textContent = `${val > 0 ? '+' : ''}${val.toFixed(1)}%`;
        trend30dEl.className = 'stat-item-value ' + (val > 0 ? 'negative' : 'positive');
      } else {
        trend30dEl.textContent = '-';
        trend30dEl.className = 'stat-item-value';
      }
      
      // Lowest seen
      const lowestEl = document.getElementById('lowest-seen');
      if (stats.lowest_seen !== null) {
        lowestEl.textContent = `‚Ç¨${stats.lowest_seen.toFixed(2)}`;
      } else {
        lowestEl.textContent = '-';
      }
      
      // Days tracked
      document.getElementById('days-tracked').textContent = daysTracked;
    }
    
    // ============================================
    // ACTIONS
    // ============================================
    function trackSet() {
      const token = localStorage.getItem('scoutloot_user');
      const user = JSON.parse(localStorage.getItem('scoutloot_user') || 'null');
      const setNumber = currentSetData?.set?.set_number;
      
      if (!token || !user) {
        // Not logged in - store set and show signup
        sessionStorage.setItem('pendingWatchSet', setNumber);
        window.location.href = '/?action=signup&set=' + setNumber;
        return;
      }
      
      // User is logged in - store in sessionStorage and redirect to dashboard
      sessionStorage.setItem('pendingWatchSet', setNumber);
      window.location.href = '/';
    }
    
    // ============================================
    // HELPERS
    // ============================================
    function showError(message) {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-state').style.display = 'flex';
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatMarketplace(marketplace) {
      const names = {
        'EBAY_DE': 'eBay Germany',
        'EBAY_GB': 'eBay UK',
        'EBAY_FR': 'eBay France',
        'EBAY_ES': 'eBay Spain',
        'EBAY_IT': 'eBay Italy',
        'EBAY_US': 'eBay USA',
        'EBAY_CA': 'eBay Canada',
      };
      return names[marketplace] || marketplace;
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
      });
    }
  </script>
</body>
</html>
